name: Build Docker Image

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "CMake Build Type (Only effective when triggered manually)"
        options: [Debug, Release, RelWithDebInfo, MinSizeRel]
  pull_request:
    paths-ignore:
      - tlaplus/**
    branches:
      - main
  push:
    paths-ignore:
      - tlaplus/**
    branches:
      - main
      - ci/*
    tags:
      - "*"

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  flowmq-version:
    runs-on: ubuntu-latest-4c

    steps:
      - uses: actions/checkout@v4
      - name: Set FLOWMQ_VERSION
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "FLOWMQ_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            LAST_TAG=$(git tag --list --sort=-creatordate | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_TAG"
            NEW_MINOR=$((MINOR + 1))
            echo "FLOWMQ_VERSION=${MAJOR}.${NEW_MINOR}.0-dev" >> $GITHUB_ENV
          fi

      - name: echo FLOWMQ_VERSION
        run: |
          echo ${{ env.FLOWMQ_VERSION }}
